{"version":"Notebook/1.0","items":[{"type":1,"content":"{\"json\":\"# annotation fails when it succeeds with no results\\n---\\n\\nopen up the `aitoolsforvisualstudio-prod` resource in any of the metricsexplorer/events/sessions/users blades that attempt to retrieve annotations.\\n\\nin the chrome debug console you'll see: \\n\\n`AI: StringValueTooLong message:\\\"string value is too long. It has been truncated to 1024 characters.\\\" props:\\\"{value:at Function.g [as defer] (https://ms.portal.azure.com/Content/Dynamic/MsPortalFxStable_7BF1ED9A8BB99E78370EFA26C10D7217AFADB43D.js:185:71)\\\\n    at t.then (https://ms.portal.azure.com/Content/Dynamic/MsPortalFxStable_7BF1ED9A8BB99E78370EFA26C10D7217AFADB43D.js:191:665)\\\\n    at t.allSettled (https://ms.portal.azure.com/Content/Dynamic/MsPortalFxStable_7BF1ED9A8BB99E78370EFA26C10D7217AFADB43D.js:194:777)\\\\n    at Function.bi [as allSettled] (https://ms.portal.azure.com/Content/Dynamic/MsPortalFxStable_7BF1ED9A8BB99E78370EFA26C10D7217AFADB43D.js:188:870)\\\\n    at Object.<anonymous> (https://jgardner-ibiza.redmond.corp.microsoft.com/Content/Scripts/Overview/ViewModels/AspNetOverviewBladeViewModel.js:50:51)\\\\n    at Object.<anonymous> (https://ms.portal.azure.com/Content/Dynamic/MsPortalFxStable_7BF1ED9A8BB99E78370EFA26C10D7217AFADB43D.js:55:575)\\\\n    at c (https://ms.portal.azure.com/Content/Dynamic/MsPortalFxStable_7BF1ED9A8BB99E78370EFA26C10D7217AFADB43D.js:54:256)\\\\n    at Object.add [as done] (https://ms.portal.azure.com}\\\"`\\n\\ndebugging in, this comes out of this code in InsightsTelemetry.instrumentAndProfile:\\n\\n                    // additional telemetry is to investigate why some part load failures have unknown status code. This can be removed once the investigation is done.\\n                    $.extend(properties3, { Error: JSON.stringify(args2) });\\n\\nthe only useful information i found there was  that this is an \\\"Other load\\\" custom event that is failing, so it stuffs the entire failure info into a custom event's Error property.\\n\\n## how often is it happening in prod every 7d?\"}"},{"type":3,"content":"{\"version\":\"KqlItem/1.0\",\"query\":\"customEvents\\r\\n| where timestamp > ago(7d)\\r\\n| where name == \\\"Other load\\\"\\r\\n| extend error = tostring(customDimensions.Error)\\r\\n| where isnotempty(error) \\r\\n| extend status = tostring(customDimensions.Status)\\r\\n| extend result = tostring(customDimensions.Result)\\r\\n| extend part = tostring(customDimensions.PartName)\\r\\n| summarize count() by status, result, part\\r\\n\",\"showQuery\":false,\"size\":1,\"visualization\":\"barchart\"}"},{"type":1,"content":"{\"json\":\"# lol.\\nOver the last 7 days, 124k annotation calls \\\"succeeeded\\\" with a 200 status, but NO data, so entitycache throws an exception and rejects the promise.    that's about 1000 per hour during work days and less on the weekends.\\n\\n## this only happens in annotation view model:\\nthe above query, but `| summarize count() by part`\"}"},{"type":3,"content":"{\"version\":\"KqlItem/1.0\",\"query\":\"customEvents\\r\\n| where timestamp > ago(7d)\\r\\n| where name == \\\"Other load\\\"\\r\\n| extend error = tostring(customDimensions.Error)\\r\\n| where isnotempty(error) \\r\\n| extend status = tostring(customDimensions.Status)\\r\\n| where status == \\\"200\\\"\\r\\n| extend part = tostring(customDimensions.PartName)\\r\\n| summarize count() by part\\r\\n\",\"showQuery\":false,\"size\":0,\"visualization\":\"piechart\"}"},{"type":1,"content":"{\"json\":\"in this case, the `AnnotationQuery.transform` method is never called.  i wonder if this would go away if the response returned an empty array `[]` instead of returning literally no response when it is a 200?\\n\\nor we need to complain to ibiza to not freak out if a query returns no content?  \\n\\nor someone needs to dig into entity cache some more?\"}"}]}